\documentclass[a4paper]{article}
\usepackage{verbatim}

\begin{document}
What is this about?

We wanted to build something in Ubuntu similar to jails in FreeBSD,
i.e. have a full system in a subtree without the riscs of breaking out.
Additionally we wanted it to be very secure, even root shouldn't be able to modify files.
Schroots were our weapon of choice. We first build a master schroot containing the system and programs to run. At any point we can start the master schroot to install programs.

Then we built clones of the master schroot. They mount everything readonly from the master schroot, except some temporary folders to store temporary files generated by processes (in our case M2). This document contains very detailed information on what to do.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%
%%%  Preparation
%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Preparation}

Install the following

\begin{verbatim}
sudo apt-get install schroot debootstrap
\end{verbatim}

For modifying schroot

\begin{verbatim}
sudo apt-get install g++ libboost-dev libboost-program-options-dev\
   libboost-regex-dev libboost-filesystem-dev
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%
%%%  The master
%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Creating the master}
\subsection{Building precise}
First we don't want anything from the outside world going into the master.
Assume we are in a folder 'fakeroots', create a folder for the master

\begin{verbatim}
cd fakeroots
mkdir master
\end{verbatim}

Let path2master be the absolute path of the fakeroots folder.
Now install precise into the master folder

\begin{verbatim}
sudo debootstrap --variant=buildd --arch=amd64 precise 
   path2master/master 
   http://archive.ubuntu.com/ubuntu
\end{verbatim}

(all in one line)
Replace precise by another version if needed.

Go into the folder

\begin{verbatim}
cd path2master/master/etc/apt
\end{verbatim}

and modify the sources.list according to your needs. In my case I used

\begin{verbatim}
http://repogen.simplylinux.ch/
\end{verbatim}

to create a sources.list for me.
\subsection{Creating the master profile}

Start by duplicating the default profile

\begin{verbatim}
cd /etc/schroot
sudo mkdir master
sudo cp default/* master
\end{verbatim}

Now we need to modify the profile for not getting some files from the outside

\begin{verbatim}
cd /etc/schroot/master
sudo vim fstab
\end{verbatim}

Comment out all lines, except the line with /proc in fstab. 

Later also comment out the lines in copyfiles and nssdatabases. 
Then schroot won't copy the passwd file and /proc won't be mounted from the outside.
Somehow it's important to have initial copies of these files, though, for having a sane system. If there aren't any sane versions of these files, M2 will segfault.
Also if you update these files and want them updated inside you will have to uncomment these files.

Modify the configuration file to have the correct paths

\begin{verbatim}
sudo vim /etc/schroot/master/config
\end{verbatim}

it should look like

\begin{verbatim}
# Settings for "master" profile.
FSTAB="/etc/schroot/master/fstab"
COPYFILES="/etc/schroot/master/copyfiles"
NSSDATABASES="/etc/schroot/master/nssdatabases"
\end{verbatim}

Next I created the configuration file

\begin{verbatim}
cd /etc/schroot/chroot.d
touch master.conf
\end{verbatim}

And filled it with the following content

\begin{verbatim}
[master]
description=Ubuntu precise pangolin master chroot
directory=path2master/master
root-users=lars <- your username here.
type=directory
users=m2user
script-config=master/config <- total path doesn't work
\end{verbatim}

Note that apparently all the users mentioned here have to exist on the outside as well.
We definetely have to modify the passwd file, since at this point it is a copy from the outside.

\subsection{Installing M2 and other things}

Move the M2 sources to a location (for example /home) inside the chroot:

\begin{verbatim}
sudo cp M2-1.4.0.1.tar.gz path2master/master/home/
\end{verbatim}

Now start the master schroot

\begin{verbatim}
schroot -c master -u root
\end{verbatim}

NO sudo in front of this command. Once inside, install everything you need using apt.
Note that you might get an error message depending on whether the folder you start the schroot in also exists in the schroot environment or not.

Inside the chroot

\begin{verbatim}
cd /home
tar -xzf M2-1.4.0.1.tar.gz
cd /
mkdir M2
mv /home/installed/* M2
rm -rf /home/installed/
rm /home/M2-1.4.0.1.tar.gz
apt-get update
apt-get upgrade
apt-get install vim
vim /etc/profile
\end{verbatim}

At the end of this file add the line

\begin{verbatim}
PATH=$PATH:/M2/bin
\end{verbatim}

Close the file and the schroot (Ctrl+d). You can restart the schroot and check the PATH variable for correctness.

Install all packages needed for M2. Start the schroot as root and inside

\begin{verbatim}
apt-get install libxml2 graphviz curl
M2
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%
%%%  Modifying the schroot source
%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Modifying the schroot source}

The problem we are trying to solve is the following:
We want to mount the /etc and /root folder inside the clone. Inside the clone they need to be writable but we need their outer versions to be unchanged.
This can be solved in the fstab with an entry like

\begin{verbatim}
none  /etc  aufs  br:/tmp=rw:/etc=ro   0  0
\end{verbatim}

This will mount both the outside /tmp and the outside /etc folder onto the inner /etc. Changes in the inner /etc would be kept in the outer /tmp and leave the outer /etc unharmed.

But now a new problem arises, namely all changes for all users would be kept in the same /tmp folder and could cause trouble, thus we want something like:

\begin{verbatim}
tmpfs    /tmpetc  tmpfs  nodev,nouid  0  0
none  /etc  aufs  br:/absolute/path/to/tmpfs=rw:/etc=ro  0  0
\end{verbatim}

Thus we somehow need to enter the absolute path to the individually created /tmpetc.

The solution is to make the following work:

\begin{verbatim}
tmpfs    /tmpetc  tmpfs  nodev,nouid  0  0
none  /etc  aufs  br:$FULL_MOUNT_PATH/tmpfs=rw:/etc=ro  0  0
\end{verbatim}

In order to do so:

\begin{verbatim}
mkdir schroot-source
cd schroot-source
wget https://launchpad.net/debian/sid/+source/schroot/1.4.25-1/+files/schroot_1.4.25.orig.tar.bz2
tar xvf schroot_1.4.25.orig.tar.bz2
mkdir testing
cd schroot_1.4.25
./configure --prefix=path2testing/testing
\end{verbatim}

If all packages from the start are installed this works.
Now for the editing

\begin{verbatim}
vim schroot-source/schroot_1.4.25/bin/schroot-mount/schroot-mount-main.cc
\end{verbatim}

Go to the action_mount method and after the line

\begin{verbatim}
d = std::string("/") + d;
\end{verbatim}

insert the following

\begin{verbatim}
std::string full_path = opts->mountpoint;
std::string eopts = entry.options;
std::string fp = "$FULL_MOUNT_PATH";
size_t start = eopts.find(fp);
while(start != std::string::npos){
   eopts.replace(start, fp.length(), full_path);
   start = eopts.find(fp);
}
entry.options = eopts;
\end{verbatim}

Now compile

\begin{verbatim}
cd schroot-source/schroot_1.4.25
make -j5
make install
\end{verbatim}

This might need some error messages. But hopefully it created the right file before. Try to copy it

\begin{verbatim}
sudo cp source/testing/libexec/schroot/schroot-mount \
   /usr/lib/x86_64-linux-gnu/schroot/schroot-mount 
\end{verbatim}

Now you are done with this part.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%
%%%  The Clone
%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Cloning the master schroot}

We want to prepare a profile for the clones

\begin{verbatim}
cd /etc/schroot
sudo mkdir clone
sudo cp master/* clone
cd clone
sudo vim config
\end{verbatim}

edit this to look like

\begin{verbatim}
# Settings for "clone" profile.
FSTAB="/etc/schroot/clone/fstab"
COPYFILES="/etc/schroot/clone/copyfiles"
NSSDATABASES="/etc/schroot/clone/nssdatabases"
\end{verbatim}

\subsection{Readonly stuff from master}

Edit the fstab to fetch the master files

\begin{verbatim}
sudo vim /etc/schroot/clone/fstab
\end{verbatim}

it should look like

\begin{verbatim}
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
/proc      /proc    none    bind        0       0
/proc      /proc    none    remount,bind,ro        0       0
/fakeroots/master/bin /bin  none  bind     0  0
/fakeroots/master/bin /bin  none  remount,bind,ro      0  0
/fakeroots/master/cbin /cbin  none  bind     0  0
/fakeroots/master/cbin /cbin  none  remount,bind,ro      0  0
/fakeroots/master/usr /usr  none  bind     0  0
/fakeroots/master/usr /usr  none  remount,bind,ro      0  0
/fakeroots/master/srv /srv  none  bind     0  0
/fakeroots/master/srv /srv  none  remount,bind,ro      0  0
/fakeroots/master/lib /lib  none  bind     0  0
/fakeroots/master/lib /lib  none  remount,bind,ro      0  0
/fakeroots/master/lib64 /lib64  none  bind     0  0
/fakeroots/master/lib64 /lib64  none  remount,bind,ro      0  0
/fakeroots/master/sys /sys  none  bind     0  0
/fakeroots/master/sys /sys  none  remount,bind,ro      0  0
/fakeroots/master/selinux /selinux  none  bind     0  0
/fakeroots/master/selinux /selinux  none  remount,bind,ro      0  0
/fakeroots/master/var /var  none  bind     0  0
/fakeroots/master/var /var  none  remount,bind,ro      0  0
/fakeroots/master/boot   /boot none  bind     0  0
/fakeroots/master/boot   /boot none  remount,bind,ro      0  0
/fakeroots/master/media   /media none  bind     0  0
/fakeroots/master/media   /media none  remount,bind,ro      0  0
/fakeroots/master/opt /opt  none  bind     0  0
/fakeroots/master/opt /opt  none  remount,bind,ro      0  0
/fakeroots/master/run /run  none  bind     0  0
/fakeroots/master/run /run  none  remount,bind,ro      0  0
/fakeroots/master/mnt /mnt  none  bind     0  0
/fakeroots/master/mnt /mnt  none  remount,bind,ro      0  0
/fakeroots/master/M2 /M2  none  bind     0  0
/fakeroots/master/M2 /M2  none  remount,bind,ro      0  0

# Temporary file systems
tmpfs   /tmp    tmpfs   nodev,nosuid,size=32M   0       0
tmpfs   /home/franzi    tmpfs   nodev,nosuid,size=32M,rw,uid=1001,gid=1001      0       0
tmpfs   /home/lars      tmpfs   nodev,nosuid,size=32M,rw,uid=1000,gid=1000      0       0
tmpfs   /home/mike      tmpfs   nodev,nosuid,size=32M,rw,uid=1002,gid=1002      0       0

# Mounting readonly folders writable
tmpfs   /tmpetc tmpfs   nodev,nosuid,size=4M    0       0
none    /etc    aufs    br:$FULL_MOUNT_PATH/tmpetc=rw:/fakeroots/master/etc=ro  0       0
tmpfs   /tmproot        tmpfs   nodev,nosuid,size=4M    0       0
none    /root   aufs    br:$FULL_MOUNT_PATH/tmproot=rw:/fakeroots/master/root=ro        0       0
\end{verbatim}

Please bear with me for not modifying the paths.

In the nssdatabases and copyfiles file comment out all lines.

Note that we do not have a sbin folder at all.

Now one can run the schroot. At desctruction the also the folders /etc and /root are eliminated.

\subsection{Configuring the clone}

Create a folder for the clone (maybe inside fakeroots)

\begin{verbatim}
cd fakeroots
mkdir clone
\end{verbatim}

Edit the clone chroot config

\begin{verbatim}
cd /etc/schroot/chroot.d
sudo vim clone.conf
\end{verbatim}

to look like

\begin{verbatim}
[clone]
description=Ubuntu precise pangolin clone chroot
directory=path2clone/clone
root-users=lars
type=directory
users=m2user
script-config=clone/config
\end{verbatim}

\subsection{First test of the clone}

Start the clone and check it

\begin{verbatim}
schroot -c clone -u root
touch /bin/bla
\end{verbatim}

should yield

\begin{verbatim}
touch: cannot touch `/bin/bla': Read-only file system
\end{verbatim}

\subsection{todo}

Store the configuration files in a location such that copyfiles fetches them every time we start. I.e. also modify copyfiles accordingly.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%
%%%  Schroot Commands
%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Schroot Commands}
\subsection{Basic commands}
One can list all schroots with

\begin{verbatim}
schroot -l
\end{verbatim}

Kill all schroots with

\begin{verbatim}
schroot -e --all-sessions
\end{verbatim}

\subsection{Naming the schroots}
Start a schroot with given id name. Then access it as a user

\begin{verbatim}
schroot -c chroot -n name -b
schroot -c name -u user -r
\end{verbatim}

It is not possible to log into the named schroot immediately.

Alternatively start M2 when logging on

\begin{verbatim}
schroot -c name -u user -r /M2/bin/M2 -d /home/user 
\end{verbatim}

Of course this directory should exist.

Ending this schroot
\begin{verbatim}
schroot -c name -e
\end{verbatim}

One can use this to let the schroot know its name:

\begin{verbatim}
schroot -c name -d existing/rw/dir -u user -r touch name
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%
%%%  Possible Traps
%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Possible Traps}
\begin{itemize}
\item Look at /etc/passwd. For some reason all users of the top system appear here. This might be good for others but not for us.

One can resolve this by manipulating the files in /etc/schroot/default. In this case the nssdatabases file is the one to be manipulated.
\item The shell via ssh looks weird.
\item We want different ports for all schroots, but we only have one file we can change.
\end{itemize}

\section{Things to delete}
\begin{itemize}
\item[sbin] Don't mount this folder at all.
\item[/usr/sbin] Maybe don't mount this folder at all.
\end{itemize}
\end{document}
